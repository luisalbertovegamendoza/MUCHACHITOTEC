{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>{% block title %}JJ TecnologÃ­a{% endblock %}</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Font Awesome 6 (CORRECTO) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      crossorigin="anonymous"
    />

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'css/styless.css' %}" />
    {% block extra_css %}{% endblock %}
  </head>

  <body class="d-flex flex-column min-vh-100">
    {% if messages %}
    <div
      class="position-fixed top-0 start-50 translate-middle-x mt-3"
      style="z-index: 1050; width: 400px"
    >
      {% for message in messages %}
      <div
        class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show"
        role="alert"
      >
        {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- HEADER -->
    {% include 'common/header.html' %}

    <!-- CONTENIDO DINÃMICO -->
    <main class="flex-grow-1 main-bg">{% block content %}{% endblock %}</main>

    <!-- FOOTER -->
    {% include 'common/footer.html' %}

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const mensajeBienvenida = `
      ğŸ‘‹ <b>Bienvenido a MUCHACHITO TEC</b><br><br>
      <b>Â¿En quÃ© puedo ayudarte?</b><br><br>

      1ï¸âƒ£ <b>Productos</b> ğŸ›’<br>
      2ï¸âƒ£ <b>EnvÃ­os</b> ğŸšš<br>
      3ï¸âƒ£ <b>Pagos</b> ğŸ’³<br>
      4ï¸âƒ£ <b>Horarios</b> â°<br>
      5ï¸âƒ£ <b>Contacto</b> ğŸ“<br><br>

      âœï¸ Escribe el <b>nÃºmero</b> o la <b>palabra</b>
      `;
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const alerts = document.querySelectorAll(".alert");

        alerts.forEach(function (alert) {
          setTimeout(function () {
            alert.classList.remove("show");
            alert.classList.add("fade");

            setTimeout(function () {
              alert.remove();
            }, 500);
          }, 2000); // â±ï¸ 3 segundos
        });
      });
    </script>

    <div class="modal fade" id="contactoModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ğŸ“© ContÃ¡ctanos</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <div class="modal-body">
            <form method="POST" action="{% url 'contacto' %}">
              {% csrf_token %}

              <div class="mb-3">
                <label class="form-label">Nombre</label>
                <input
                  type="text"
                  name="nombre"
                  class="form-control"
                  placeholder="Tu nombre"
                  required
                />
              </div>

              <div class="mb-3">
                <label class="form-label">Correo</label>
                <input
                  type="email"
                  name="email"
                  class="form-control"
                  placeholder="correo@email.com"
                  required
                />
              </div>

              <div class="mb-3">
                <label class="form-label">TelÃ©fono</label>
                <input
                  type="tel"
                  name="telefono"
                  class="form-control"
                  placeholder="Tu nÃºmero de celular"
                  required
                />
              </div>

              <div class="mb-3">
                <label class="form-label">Mensaje</label>
                <textarea
                  name="mensaje"
                  class="form-control"
                  rows="4"
                  placeholder="Escribe tu mensaje..."
                  required
                ></textarea>
              </div>

              <button type="submit" class="btn btn-contacto w-100">
                Enviar mensaje ğŸš€
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- BOTÃ“N CHAT -->
    <button
      id="chatBtn"
      style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #0d6efd;
        color: #fff;
        font-size: 24px;
        border: none;
        z-index: 9999;
      "
    >
      ğŸ’¬
    </button>

    <!-- CHATBOX -->

    <!-- CHATBOX -->
    <div
      id="chatBox"
      style="
        display: none;
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 300px;
        height: 400px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 10px;
        padding: 10px;
        z-index: 9999;
      "
    >
      <div
        id="chatMensajes"
        style="height: 300px; overflow-y: auto; font-size: 14px"
      ></div>

      <textarea
        id="chatInput"
        class="form-control mt-2"
        rows="2"
        placeholder="Escribe tu mensaje..."
      ></textarea>
    </div>

    <script>
      const chatBox = document.getElementById("chatBox");
      const chatBtn = document.getElementById("chatBtn");
      const chatMensajes = document.getElementById("chatMensajes");
      const chatInput = document.getElementById("chatInput");

      let chatIniciado = false;

      chatBtn.onclick = () => {
        chatBox.style.display =
          chatBox.style.display === "none" ? "block" : "none";

        if (!chatIniciado && chatBox.style.display === "block") {
          chatMensajes.innerHTML += `<div><b>Bot:</b> ${mensajeBienvenida}</div>`;
          chatMensajes.scrollTop = chatMensajes.scrollHeight;
          chatIniciado = true;

          reproducirAudioBarrio(); // ğŸ”Š bienvenida
        }
      };

      function enviarMensaje() {
        let mensaje = chatInput.value.trim();
        if (!mensaje) return;

        chatMensajes.innerHTML += `<div><b>TÃº:</b> ${mensaje}</div>`;
        chatInput.value = "";

        fetch("/chatbot/responder/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mensaje }),
        })
          .then((res) => res.json())

          .then((data) => {
            chatMensajes.innerHTML += `<div><b>Bot:</b> ${data.respuesta}</div>`;
            chatMensajes.scrollTop = chatMensajes.scrollHeight;

            reproducirAudioBarrio();
          });
      }

      // ENTER = enviar | SHIFT + ENTER = salto
      chatInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          enviarMensaje();
        }
      });
    </script>

    <script>
      let audioPermitido = false;

      // Necesario para que el navegador permita audio
      document.addEventListener("click", () => {
        audioPermitido = true;
      });

      function reproducirAudioBarrio() {
        if (!audioPermitido) return;

        const audio = document.getElementById("audioBarrio");
        audio.currentTime = 0;
        audio.play().catch(() => {});
      }
    </script>

    <audio
      id="audioBarrio"
      src="{% static 'sounds/bot.mp3' %}"
      preload="auto"
    ></audio>
  </body>
</html>
